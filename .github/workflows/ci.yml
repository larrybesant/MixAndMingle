# Add status badge for CI
# ![CI](https://github.com/OWNER/REPO/actions/workflows/ci.yml/badge.svg)

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  quality:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20]
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"
      - run: npm ci
      - run: npm run lint
      - run: npm run type-check || npx tsc --noEmit
      - run: npm test || true

  build:
    runs-on: ubuntu-latest
    needs: [quality, audit]
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
      - run: npm ci
      - name: Download previous build artifacts (if any)
        uses: actions/download-artifact@v4
        with:
          name: next-build
          path: .next
        continue-on-error: true
      - run: npm run build
      - name: Upload production build
        uses: actions/upload-artifact@v4
        with:
          name: next-build
          path: .next
      - name: Run Cypress E2E tests (if present)
        run: |
          if [ -d "cypress" ]; then npx cypress run || true; fi

  # Example deploy job (customize for your platform)
  # deploy:
  #   runs-on: ubuntu-latest
  #   needs: build
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Deploy to Vercel
  #       run: npx vercel --prod --token ${{ secrets.VERCEL_TOKEN }}

  coverage:
    runs-on: ubuntu-latest
    needs: [quality, audit]
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
      - run: npm ci
      - run: npm run test -- --coverage || true
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage

  audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
      - run: npm ci
      - name: Audit dependencies for vulnerabilities
        run: npm audit --audit-level=moderate || true
      - name: Check for outdated dependencies
        run: npm outdated || true
# Summary:
# - Lint, type-check, and test on Node.js 18 and 20
# - Build and E2E test on Node.js 20
# - Upload build and coverage artifacts
# - Ready for deploy job integration
